# 3.3 改变预期

> 跟着 Ben Jaffe 学习为什么结构良好的代码很重要，以及如何使用 MV 方法创建更简洁的项目。

---

[TOC]

---

## 1. 欢迎



---

## 2. 介绍 Cat Clicker 和 Andy



---

## 3. Cat Clicker 要求

### Cat Clicker 项目要求

#### 视觉

- 该应用程序应该显示猫的图片和点击数。
- 布局的细节无关紧要，因此可以按照你喜欢的方式设置样式。

#### 交互

- 点击猫的图片时，点击数应该增加。

#### 灵感

![](assets/unnamed-3.jpg)

感谢 poplinre 提供本图片。

#### 资源

如果你需要复习事件和事件侦听程序，这里有一些链接。

如果你要通过 vanilla JS（不是 jQuery）编写 Cat Clicker，你将通过 [elem.addEventListener()](https://developer.mozilla.org/zh-CN/docs/Web/API/EventTarget/addEventListener) 添加“点击”事件监听事件。

```
var elem = document.getElementById('my-elem');
elem.addEventListener('click', function(){
  // 该元素已被点击...在这里做东西
}, false);
```

如果你在使用 jQuery，你需要使用 [jQuery.click()](https://www.jquery123.com/click/) / [英](http://api.jquery.com/click/) 添加“点击”事件监听事件。

```
$('#my-elem').click(function(e) {
  // 该元素已被点击...在这里做东西
});
```

---

## 4. 思考



---

### 视频中的图片练习

#### 思考

请你思考几个问题：

这个项目对你来说有多难？

你对代码有何感受？

你在 '猫' 上点击了多少次？

---

## 5. Andy 的思考



---

## 6. 要求会不断变化



---

## 7. 第一个要求变化



---

## 8. Cat Clicker 要求 2

### Cat Clicker 项目的新要求

#### 视觉

- 该应用程序应该显示两只猫。每只猫都包括 
  - 猫的名称
  - 猫的图片
  - 显示点击数的文本
- 布局的细节无关紧要，因此可以按照你喜欢的方式设置样式。

#### 交互

- 点击每张猫的图片时，点击数应该增加。

#### 灵感

![](assets/unnamed.jpg)

感谢 chewie 提供本图片。

---

## 9. 思考2



---

## 10. Andy 的思考 2



---

## 11. 闭包和事件侦听程序

# 闭包和事件侦听程序

## 问题：

假如我们要为数组中的每个元素分别创建一个 dom 元素。单击任一个 dom 元素，它会使用 alert() 提示其对应数字。简单的方法是使用 for 循环遍历列表元素。单击时，会提示我们在迭代数组每个元素时的 `num` 值。这里提供了一个示例：

```
// 清屏
document.body.innerHTML = '';
document.body.style.background="white";

var nums = [1,2,3];

// 让我们循环遍历数组中的所有数字
for (var i = 0; i < nums.length; i++) {

   // 这是循环中当前的数字
   var num = nums[i];

   // 我们为这个数字创建一个DOM元素
   var elem = document.createElement('div');
   elem.textContent = num;

   // ... 然后当点击 (click) 的时候，使用 alert() 提示这个数字
   elem.addEventListener('click', function() {
      alert(num);
   });

   // 最后，我们把这个 dom 元素插入到 document 中去。
   document.body.appendChild(elem);
};
```

你在任何网站中运行这段代码，它都会清除所有内容然后在页面中加入一组数字。试一试吧！打开一个新页面，打开控制台，然后运行前面的代码。接着点击数字看看它弹出了什么提示。阅读代码可以看到，我们期望每个数字在被点击时都弹出它自己的数值。

但是当我们测试的时候，所有的元素都只会弹出相同的东西：最后一个数字。这是为什么呢？

## 实际上发生了什么

让我们抛开不相干的代码，看看到底发生了什么。下面的注释已经改好了，它解释了当时到底发生了什么。

```
var nums = [1,2,3];

for (var i = 0; i < nums.length; i++) {

   // 这个变量在我们进行迭代时一直在改变 !
   //  第一个值是1，接着是2，最后是3
   var num = nums[i];

   // 点击时...
   elem.addEventListener('click', function() {

      // ... 在点击的时候提示num的值!
      alert(num);

      // 很明显，我们提示 num 变量的值
      // 它在内部函数(指的是 addEventListener 中的匿名函数)的外面被定义。
      // 每个内部函数都指向同一个 'num' 变量… 而 'num' 变量在每一次的迭代中都发生了变化，
      // 在循环的最后它被定义为3。无论何时，点击事件调用的匿名函数都会引用同一个 'num' 变量(现在它等于3)
   });
};
```

这就是为什么不管我们点击什么数字都会弹出最后一个`num`值的原因。

## 如何修复这个问题?

解决方案就是使用闭包。我们将创建一个内部作用域，以便在**我们添加事件监听的时候**存住`num`的值。其实有很多种方法可以实现这个效果 -- 闭包是其中很好的一种。

让我们简化一下代码，只关注我们添加事件监听的那几行。

```
var num = nums[i];

elem.addEventListener('click', function() {

   alert(num);

});
```

`num`变量改变了，所以我们要想办法将它和我们的事件监听函数给绑起来。这儿有一种方法可以做到，首先请看代码，然后我会解释它是如何运行的。

```
elem.addEventListener('click', (function(numCopy) {
   return function() {
      alert(numCopy)
   };
})(num));
```

加粗的部分是外部函数。我们通过加上圆括号来使它立即被调用，并传入 num。这种包一个匿名函数并立即执行它的方法称为 IIFE(Immediately-Invoked Function Expression,立即执行函数表达式)。这就是我们使用的“魔法”。

我们将 `num` 值传入外部函数。在外部函数里面，这个值被命名为 `numCopy` --这个命名很合适，因为它就是 `num`的拷贝。现在 `num` 在后面的代码中改变就不是问题了。我们已经把 `num` 的值作为 `numCopy` 存在我们的外部函数里面了。

最后，外部函数把内部函数返回 (return) 给事件监听函数。由于 JavaScript 的作用域，内部函数能够访问 `numCopy`。在之后，`num`会增加，但是这已经无关紧要了。内部函数指向的是`numCopy`，它将保持不变。

现在，当点击的时候，点击事件执行的其实是返回的内部函数，提示 (alert) 的内容是 `numCopy`。

## 最终版本

这儿是我们用了的闭包技巧之后的源代码。来试一试吧！

```
// 清屏
document.body.innerHTML = '';

var nums = [1,2,3];

// 循环遍历数组中的每一个数
for (var i = 0; i < nums.length; i++) {

   // 这是数组循环中当前的数值...
   var num = nums[i];

   // 我们为这个数创建了一个 DOM 元素
   var elem = document.createElement('div');
   elem.textContent = num;

   // ... 然后当我们点击 (click) 的时候，提示这个数字
   elem.addEventListener('click', (function(numCopy) {
      return function() {
      alert(numCopy);
      };
   })(num));

   document.body.appendChild(elem);

};
```

---

## 12. 第二个要求变化



---

## 13. Cat Clicker 高级版要求

## Cat Clicker 项目高级版要求

### 视觉

- 该应用程序应该显示
  - 一个包含至少 5 只猫的列表（按名称列出）
  - 一块用于显示所选的猫的区域
- 在猫显示区域，应该会显示以下内容
  - 猫的名称
  - 猫的图片
  - 显示点击数的文本
- 布局的细节无关紧要，因此可以按照你喜欢的方式设置样式。

### 交互

- 点击列表中的猫名称时，猫显示区域应该更新以显示所选的猫的数据。
- 猫区域内的点击数应该对每只猫具有唯一性，并且应该在点击猫的图片时增加。

### 灵感

![Cute Cat for Inspiration](assets/unnamed-13.jpg)

感谢 jetske 提供本图片。

---

## 14. 思考 3

### 视频中的图片练习

#### 思考 3

这次有多难？（easy 简单 - so hard 太难了！）

对你的代码有何感受？

现在你点击猫多少次了？

---

## 15. Andy 的思考 3



---

## 16. 面条式代码故事时间



---

## 17. 什么是面条式代码



---

## 18. MVO 简介



---

## 19. “模型”练习



---

### 视频中的图片练习

#### “模型”练习

你认为在应用的这些部分中 哪个应该属于模型？

- 应用中的日历事件数组？
- 天/ 星期/ 月份按钮？
- 日历区域的渲染函数？

---

## 20. “视图”练习



---

### 视频中的图片练习

#### ”视图“ 练习

假设我想构建一个 YouTube 播放列表应用，用户可以输入 URL， 然后应用会一个个播放这个播放列表的里的视频， 这个应用的哪个部分可以看做视图？

- 输入元素
- 播放的 URL 数组
- 将 URL 添加到列表中的函数
- 视频播放的位置

---

## 21. 我们代码的模型是什么



---

## 22. 我们代码的视图是什么



---

[Pizza 代码库](https://github.com/udacity/ud989-pizzamvo-zh) 

---

## 23. 我们代码的章鱼是什么



---

[Pizza 代码库](https://github.com/udacity/ud989-pizzamvo-zh)

---

## 24. 识别新应用中的 MVO



---

[Udacity Retain 代码库](https://github.com/udacity/ud989-retain-zh) 

---

## 25. 探索应用的结构

## 探索 Udacity Retain

花几分钟来探索优达学城 Retain 应用的结构。

- 它是如何组织的？
  - 模型是否曾与视图直接对话？
  - 视图是否曾与模型直接对话？
- 如果愿意，请向代码添加注释。

你可以[在这里找到该代码库](https://github.com/udacity/ud989-retain-zh)。

---

## 26. 此功能在何处提供？



---

### 视频中的图片练习

我们希望顺序反过来， 即最新的注释应该出现在列表的第一位， 应该在哪做出更改呢？

- 在模型里
- 视图里
- 在章鱼中

---

## 27. 实施注释日期

### 视频中的图片练习

在所有新的注释中添加日，记住：

- 在注释对象中储存一个日期
- 渲染注释时可以显示日期
- 添加完成 - 我成功啦！

---

## 28. 准备第 2 课