# 3.ç¬¬3ç«  åŒæ„çš„æ¦‚å¿µçš„æ¢³ç†ğŸ…ğŸ»

[TOC]

## 3-1 ä»€ä¹ˆæ˜¯åŒæ„

é¦–å…ˆæˆ‘ä»¬æ¥çœ‹ä¸€æ®µ react ä»£ç ï¼š

```jsx
const Home = (props) => {
  return (
  <Fragment>
    <h1>My first App</h1>
    <p>This is my first app,It's awesome!</p>
    <button onClick={()=>{alert('hi~')}}>click me</button>
  </Fragment>
  )
}
```

å¯¹é¢ä¸Šé¢è¿™æ®µ Home ç»„ä»¶ä»£ç ï¼Œæˆ‘ä»¬ä½¿ç”¨ `renderToString(<Home/>)` æ–¹æ³•å°†å…¶è½¬æ¢ä¸º HTML å­—ç¬¦ä¸²ä»£ç å¹¶æ·»åŠ åˆ°æœåŠ¡å™¨ç«¯ï¼Œå½“å®¢æˆ·ç«¯å‘é€è¯·æ±‚å¹¶æ”¶åˆ°æœåŠ¡å™¨ç«¯å‘é€è¿‡æ¥çš„ HTML æ–‡æœ¬å¹¶æ¸²æŸ“æ—¶ï¼Œæˆ‘ä»¬ç‚¹å‡»é¡µé¢ä¸Šçš„ button æŒ‰é’®å¹¶ä¸ä¼šæ‰§è¡Œ `alert('hi~')` è¿™æ®µä»£ç ï¼ŒåŸå› æ˜¯å› ä¸º renderToString() æ–¹æ³•åªè´Ÿè´£å°† React ä»£ç è½¬æ¢ä¸º HTML æ–‡æœ¬ï¼Œä½†å¹¶ä¸ä¼šæ‰§è¡Œç»‘å®šäº‹ä»¶çš„ä»£ç ã€‚

å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªåŠæ³•æ¥è®©ç»‘å®šçš„äº‹ä»¶ç”Ÿæ•ˆï¼Œæ‰€ä»¥å°†ä¸Šé¢è¿™æ®µä»£ç å†åœ¨æµè§ˆå™¨ç«¯è¿è¡Œä¸€æ¬¡ï¼Œä»è€Œè®©æµè§ˆå™¨ç«¯èƒ½å¤Ÿå®ç°äº‹ä»¶çš„ç»‘å®šã€‚

è¿™ç§å°†ä¸€å¥—ä»£ç ï¼Œåœ¨æœåŠ¡å™¨ç«¯æ‰§è¡Œä¸€æ¬¡ï¼Œå†åœ¨å®¢æˆ·ç«¯æ‰§è¡Œä¸€æ¬¡çš„æ–¹æ¡ˆå°±å«**åŒæ„**ã€‚ï¼ˆè¿™é‡Œæˆ‘ä»¬çš„ä¸€å¥—ä»£ç æŒ‡çš„æ˜¯ React ä»£ç ï¼‰

## 3-2 åœ¨æµè§ˆå™¨ä¸Šæ‰§è¡Œä¸€æ®µ JS ä»£ç 

ç”±äºåœ¨æµè§ˆå™¨ä¸Šæ‰€è¿è¡Œçš„ä»£ç æ¥è‡ªäºæœåŠ¡å™¨ç«¯æ¸²æŸ“ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥ç”¨åœ¨å“åº”çš„æ–‡æœ¬ä¸­é€šè¿‡`script`æ ‡ç­¾è¯·æ±‚å¹¶è¿è¡Œä¸€æ®µ JS ä»£ç ï¼Œå¦‚ä¸‹ï¼š

```js
app.get('/', (req, res) =>
  res.send(`<html>
<head>
  <title>App</title>
</head>
<body>
  ${reactContent}
  <script src='./index.js'></script>
</body>
</html>`)
) // å½“ä½ è®¿é—®è¿™ä¸ªåº”ç”¨çš„æ ¹è·¯å¾„æ—¶ï¼Œä¼šå‘é€ä¸€æ®µæ–‡æœ¬
```

ä½†æ˜¯ä¸Šé¢çš„è¿™æ®µä»£ç éœ€è¦æˆ‘ä»¬é…ç½® ./index.js çš„è·¯ç”±ã€‚å¦åˆ™ä¼šæ”¶åˆ°ä¸‹é¢è¿™æ®µæç¤ºï¼š

`GET http://localhost:3000/index.js net::ERR_ABORTED 404 (Not Found)`

åœ¨ express ä¸­ï¼Œä½ å¯ä»¥é€šè¿‡å¦‚ä¸‹æ–¹å¼æ¥è®¾ç½®è·¯ç”±ï¼š

```js
app.get('./index.js',(req,res)=>{
  res.send(`
  document.querySelector('button').addEventListener('click',()=>{alert('hi~')})
  `)
})
```

å½“å®¢æˆ·ç«¯è¯·æ±‚ `localhost:3000/index.js` æ—¶ï¼Œå°±ä¼šè¿”å›ä¸€æ®µä¸Šé¢çš„è„šæœ¬ä»£ç ï¼Œå¹¶ä¸”æ‰§è¡Œã€‚

ä½†æ˜¯å¯¹äºé™æ€æ–‡ä»¶ï¼Œæˆ‘ä»¬æ¯ä¸€æ¬¡éƒ½å†™ä¸€ä¸ªè·¯ç”±é‚£å°±ä¼šå¾ˆéº»çƒ¦ã€‚å› æ­¤æˆ‘ä»¬å¯ä»¥å€ŸåŠ© express æ¥å¸®åŠ©æˆ‘ä»¬è§£å†³è¿™ä¸ªé—®é¢˜ã€‚

```js
app.use(express.static('public')) // ä½¿ç”¨ä¸­é—´ä»¶ï¼Œå½“ express åˆ›å»ºçš„æœåŠ¡å™¨å‘ç°ä½ è¯·æ±‚ä¸€ä¸ªé™æ€æ–‡ä»¶ï¼Œå°±ä¼šå¸®ä½ åœ¨æ ¹ç›®å½•ä¸‹çš„ public ç›®å½•ä¸­å»æ‰¾
// æ³¨æ„éœ€è¦åœ¨æ ¹ç›®å½•åˆ›å»º public ç›®å½•ï¼Œå¹¶åˆ›å»ºéœ€è¦è¿”å›çš„é™æ€æ–‡ä»¶ï¼Œæ¯”å¦‚è¿™é‡Œçš„ index.js
```

å¦‚ä¸Šï¼Œé€šè¿‡ä½¿ç”¨ä¸­é—´ä»¶ï¼Œå½“æˆ‘ä»¬è¯·æ±‚ä¸€ä¸ªé™æ€èµ„æºï¼ŒæœåŠ¡å™¨å°±ä¼šè‡ªåŠ¨å¸®æˆ‘ä»¬åœ¨ public æ–‡ä»¶ç›®å½•ä¸‹å»å¯»æ‰¾ç›¸åŒçš„é™æ€èµ„æºå¹¶è¿”å›ã€‚é™æ€èµ„æºï¼š.js .json ç­‰ç­‰ã€‚



## 3-3  è®© React ä»£ç åœ¨æµè§ˆå™¨ä¸Šè¿è¡Œ

é‚£ä¹ˆæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ä¼šæƒ³å°†æˆ‘ä»¬åœ¨æœåŠ¡å™¨ç«¯æ‰§è¡Œçš„ React ä»£ç æ”¾åˆ° public ç›®å½•ä¸‹çš„ index.js æ–‡ä»¶ä¸­ï¼Œå¦‚ä¸‹ï¼š

```jsx
// ./public/index
import React from 'react'
...
```

ä½†æ˜¯ä¸Šé¢ä½¿ç”¨ ES module è¯­æ³•çš„ import æ˜¯æ— æ³•åœ¨æµè§ˆå™¨ç«¯è¿è¡Œçš„ï¼Œå› ä¸ºç›®å‰çš„æµè§ˆå™¨è¿˜ä¸æ”¯æŒè¿™æ ·çš„è¯­æ³•å½¢å¼ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨ webpack å¼•å…¥ babel æ¥å°†è¿™ç§è¯­æ³•å½¢å¼è½¬æ¢ä¸ºæµè§ˆå™¨èƒ½å¤Ÿè¿è¡Œçš„è¯­æ³•å¹¶æ‰“åŒ…ã€‚

å› æ­¤ï¼Œæˆ‘ä»¬åœ¨ src ä¸‹åˆ›å»ºä¸€ä¸ª client ç›®å½•æ¥å­˜æ”¾æˆ‘ä»¬éœ€è¦åœ¨å®¢æˆ·ç«¯è¿è¡Œçš„ä»£ç ã€‚åˆ›å»º index.js æ–‡ä»¶å¹¶å†™å…¥ä¸‹é¢è¿™æ®µä»£ç ï¼š

```jsx
import React from 'react'
import ReactDom from 'react-dom'
import Home from '../containers/Home'

ReactDom.render(<Home />, document.getElementById('root'))
```

æ³¨æ„åœ¨å®¢æˆ·ç«¯æ¸²æŸ“ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨ ReactDom.render() æ–¹æ³•ï¼Œå¹¶ä¸”åœ¨é¡µé¢ä¸­åº”è¯¥å­˜åœ¨ä¸€ä¸ª div#root çš„å…ƒç´ ã€‚

æ‰€ä»¥ï¼Œåœ¨ ./src/index.js ä¸­æˆ‘ä»¬éœ€è¦æ·»åŠ ä¸€æ®µ html æ–‡æœ¬ä»£ç ä½¿é¡µé¢ä¸­å­˜åœ¨ä¸€ä¸ª div#root å…ƒç´ ï¼š

```js
`
<div id="root">
  ${reactContent}
</div>
`
```

### åˆ›å»º  webpack.client.js æ–‡ä»¶

å› ä¸ºæ‰“åŒ…ç»™æœåŠ¡å™¨ç«¯æ‰§è¡Œçš„ä»£ç ä¸æ‰“åŒ…ç»™å®¢æˆ·ç«¯æ‰§è¡Œçš„ä»£ç æ˜¯ä¸åŒçš„ï¼Œæ‰€ä»¥éœ€è¦å•ç‹¬æ–°å»ºä¸€ä¸ª webpack çš„é…ç½®æ–‡ä»¶ã€‚

åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹åˆ›å»º webpack.client.js æ–‡ä»¶ï¼Œæ–‡ä»¶çš„å†…å®¹ä¸ webpack.server.js å·®ä¸å¤šï¼Œåªæ˜¯éœ€è¦åˆ é™¤å’Œæ”¹å˜ä¸€äº›é…ç½®é¡¹ï¼Œç»“æœå¦‚ä¸‹ï¼š

```js
const path = require('path')
// åˆ é™¤äº† webpack-node-externals

module.exports = {
  mode: 'development',
  //æ”¹å˜äº†å…¥å£æ–‡ä»¶
  entry: './src/client/index.js',
  // æ”¹å˜äº†æ‰“åŒ…åçš„è·¯å¾„å’Œæ–‡ä»¶å
  output: {
    filename: 'index.js',
    path: path.resolve(__dirname, 'public')
  },
  // å…¶ä½™é…ç½®æ²¡æœ‰å˜åŒ–
  module: {
    rules: [{
      test: /\.jsx?$/,
      loader: 'babel-loader',
      exclude: /node_modules/,
      options: {
        presets: ['react', 'stage-0', ['env', {
          targets: {
            browsers: ['last 2 versions']
          }
        }]]
      }
    }]
  }
}
```

ç„¶åæˆ‘ä»¬éœ€è¦åœ¨ ./package.json ä¸­é…ç½®æ‰§è¡Œè„šæœ¬æ¥æ‰“åŒ…å®¢æˆ·ç«¯çš„ä»£ç ï¼š

```js
  "scripts": {
    "dev": "npm-run-all --parallel dev:**",
    "dev:start": "nodemon --watch build --exec node ./build/bundle.js",
    "dev:build:server": "webpack --config webpack.server.js --watch",
    "dev:build:client": "webpack --config webpack.client.js --watch"    
  },
```

å½“æˆ‘ä»¬æ‰§è¡Œ `npm run dev` åï¼Œwebpack ä¼šå¸®æˆ‘ä»¬åˆ†åˆ«å¯¹æœåŠ¡å™¨ç«¯ä¸å®¢æˆ·ç«¯çš„ä»£ç è¿›è¡Œæ‰“åŒ…å¹¶ä¸”ä¼šé€šè¿‡ node æ‰§è¡ŒæœåŠ¡å™¨ç«¯çš„ä»£ç éƒ¨ç½²ä¸€ä¸ªæœ¬åœ°æœåŠ¡å™¨ï¼Œè®¿é—®æœåŠ¡å™¨ä¼šæç¤ºä¸¤ä¸ªé”™è¯¯ï¼š

1. æˆ‘ä»¬éœ€è¦ä½¿ç”¨ `ReactDom.hydrate()` æ–¹æ³•æ¥è¿›è¡Œæ¸²æŸ“ï¼Œè€Œä¸æ˜¯åƒä»¥å¾€é‚£æ ·ä½¿ç”¨ `ReactDom.render()`

2. ç”±äºæˆ‘ä»¬ä½¿ç”¨äº† `ReactDom.hydrate()`ï¼Œåœ¨æœåŠ¡å™¨å‘é€ç»™å®¢æˆ·ç«¯çš„æ–‡æœ¬ä¸­ä¸èƒ½å¸¦æœ‰æ–‡æœ¬èŠ‚ç‚¹ï¼Œå› æ­¤éœ€è¦æŠŠä¸€äº›ç©ºæ ¼åˆ æ‰ï¼š

   ```js
   `<div id="root">${reactContent}</div>`
   ```



## 3-4 å·¥ç¨‹ä»£ç ä¼˜åŒ–æ•´ç†

### ä¼˜åŒ– webpack é…ç½®é¡¹

åœ¨ webpack.server.js å’Œ webpack.client.js ä¸¤ä¸ªæ–‡ä»¶ä¸­åŒ…å«ç›¸åŒçš„ä»£ç ï¼Œæˆ‘ä»¬åº”è¯¥æŠŠè¿™äº›ç›¸åŒçš„ä»£ç æå‡ºæ¥æ”¾å…¥ä¸€ä¸ªå•ç‹¬çš„æ–‡ä»¶ä¸­ï¼Œå†åœ¨è¿™ä¸¤ä¸ªæ–‡ä»¶ä¸­å¼•å…¥ï¼Œå®ç°å…¬ç”¨ä»£ç çš„å¤ç”¨ã€‚

å®‰è£…ä¸€ä¸ªåœ¨ webpack ä¸­ç»å¸¸ä¼šä½¿ç”¨åˆ°çš„æ¨¡å— `webpack-merge`ï¼Œå®ƒæ˜¯ä¸€ä¸ªå¯ä»¥å¸®åŠ©æˆ‘ä»¬**åˆå¹¶ webpack é…ç½®é¡¹çš„å·¥å…·**ã€‚

æ¥ä¸‹æ¥ï¼Œæ˜¯å…·ä½“çš„æ“ä½œéƒ¨åˆ†ï¼š

- æˆ‘ä»¬åœ¨æ ¹ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ª webpack.base.js çš„æ–‡ä»¶ç”¨äºé…ç½®ç›¸åŒçš„éƒ¨åˆ†ä»£ç ï¼ŒæŠŠ client å’Œ server ä¸­ç›¸åŒçš„é…ç½®é¡¹æ”¾å…¥ base ä¸­å¹¶å¯¼å‡ºã€‚

  ```js
  module.exports = {
    module: {
    ...
  }
  ```

- åœ¨ client å’Œ server ä¸­å¼•å…¥ merge å’Œ base çš„é…ç½®é¡¹ï¼Œå¹¶å°† client ä¸ server ä¸­çš„é…ç½®æ”¾å…¥ä¸€ä¸ªå•ç‹¬çš„å¯¹è±¡ï¼Œæ¥ç€ä½¿ç”¨ merge åˆå¹¶é…ç½®å¯¹è±¡ï¼Œç„¶åè¿”å›ç»™ module.exportsï¼Œå…·ä½“ä»£ç ï¼ˆä»¥ client ä¸ºä¾‹ï¼‰ï¼š

  ```js
  const path = require('path')
  const merge = require('webpack-merge')
  const config = require('./webpack.base.js')
  
  const clientConfig = {
    ...
  }
  
  module.exports = merge(config, clientConfig)
  ```



### ä¼˜åŒ– src ä¸­çš„ç›®å½•ç»“æ„

å½“å‰ ./src ä¸‹çš„ index.js æ–‡ä»¶å®é™…ä¸Šæ˜¯ server ç«¯çš„ä»£ç ï¼Œä¸ºäº†**è®©ç›®å½•ç»“æ„æ›´æ¸…æ™°**ï¼Œæˆ‘ä»¬åœ¨ ./src ä¸‹åˆ›å»ºä¸€ä¸ª server ç›®å½•ï¼Œå°† ./src/index.js ç§»åˆ° ./src/server ä¸­ã€‚

å› ä¸ºæ–‡ä»¶çš„è·¯å¾„å‘ç”Ÿçš„å˜åŠ¨ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦æ›´æ”¹ä¸è¿™ä¸ªæ–‡ä»¶ç›¸å…³çš„è·¯å¾„ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæˆ‘ä»¬å¯ä»¥å°†åŒ…çš„å¼•å…¥æ”¾åˆ°æ–‡ä»¶çš„ä¸Šé¢ï¼Œç»„ä»¶çš„å¼•å…¥æ”¾åˆ°åŒ…å¼•å…¥çš„ä¸‹é¢ï¼Œè¿™æ ·æ–¹ä¾¿æˆ‘ä»¬æŸ¥çœ‹ä»£ç å†…å®¹ã€‚

è¿™æ ·æ”¹å˜ä»¥åï¼Œæˆ‘ä»¬å°±çŸ¥é“å“ªä¸€éƒ¨åˆ†æ˜¯æœåŠ¡å™¨ç«¯æ‰§è¡Œçš„ä»£ç ï¼Œå“ªä¸€éƒ¨åˆ†æ˜¯å®¢æˆ·ç«¯æ‰§è¡Œçš„ä»£ç ã€‚



## 3-5  é˜¶æ®µæ€»ç»“

ä»¥ä¸Šæˆ‘ä»¬å·²ç»å®Œæˆäº†ä¸€ä¸ªç®€å•çš„åŒæ„é¡¹ç›®ï¼Œä¸‹é¢å¤ä¹ ä¸€ä¸‹åŒæ„çš„æµç¨‹ï¼š

1. æœåŠ¡å™¨ç«¯ä»£ç è¿è¡Œ React ä»£ç æ¸²æŸ“å‡º HTML
2. å‘é€ HTML ç»™æµè§ˆå™¨
3. æµè§ˆå™¨æ¥æ”¶åˆ°å†…å®¹å¹¶å±•ç¤º
4. æµè§ˆå™¨åŠ è½½ JS æ–‡ä»¶
5. JS ä¸­çš„ React ä»£ç åœ¨æµè§ˆå™¨ç«¯é‡æ–°æ‰§è¡Œ
6. JS ä¸­çš„ React ä»£ç **æ¥ç®¡é¡µé¢æ“ä½œ**ï¼ˆå®ç°ä¸€äº›äº‹ä»¶ç»‘å®šï¼‰





